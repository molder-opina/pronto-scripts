#!/usr/bin/env bash
#
# Reset employee passwords and ensure system user exists.
#
# Usage:
#   ./pronto-scripts/bin/pronto-reset-passwords [--password <pass>] [--email <email>]
#
# Options:
#   --password <pass>   Password to set (default: "pronto")
#   --email <email>     Reset only this employee (by email). If omitted, resets ALL.
#
# Requires: PRONTO_ENV=dev|test
#

set -euo pipefail

# ── Guard: PRONTO_ENV ──────────────────────────────────────────────
PRONTO_ENV="${PRONTO_ENV:-}"
if [[ -z "$PRONTO_ENV" ]]; then
  echo "ERROR: PRONTO_ENV no está definido. Abortando." >&2
  exit 1
fi
if [[ "$PRONTO_ENV" != "dev" && "$PRONTO_ENV" != "test" ]]; then
  echo "ERROR: PRONTO_ENV=$PRONTO_ENV no permitido. Solo dev|test." >&2
  exit 1
fi

# ── Defaults & args ───────────────────────────────────────────────
PASSWORD="pronto"
TARGET_EMAIL=""

while [[ $# -gt 0 ]]; do
  case "$1" in
    --password) PASSWORD="$2"; shift 2 ;;
    --email)    TARGET_EMAIL="$2"; shift 2 ;;
    *)          echo "Argumento desconocido: $1" >&2; exit 1 ;;
  esac
done

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"

# ── Verify containers running ─────────────────────────────────────
if ! docker compose -f "$REPO_ROOT/docker-compose.yml" ps --status running 2>/dev/null | grep -q "api"; then
  echo "ERROR: El contenedor 'api' no está corriendo." >&2
  echo "       Ejecuta primero los contenedores." >&2
  exit 1
fi

# ── Build inline Python script ────────────────────────────────────
read -r -d '' PY_SCRIPT << 'PYEOF' || true
import sys, os, logging
from uuid import uuid4

logging.basicConfig(level=logging.ERROR)

sys.path.insert(0, "/opt/pronto/pronto_api")
sys.path.insert(0, "/opt/pronto/pronto_shared")
sys.path.insert(0, "/opt/pronto/build")

from pronto_shared.config import load_config
from pronto_shared.db import get_session, init_engine
from pronto_shared.models import Employee
from pronto_shared.security import encrypt_string, hash_credentials, hash_identifier
from sqlalchemy import text

password = os.environ.get("_PRONTO_RESET_PW", "pronto")
target_email = os.environ.get("_PRONTO_TARGET_EMAIL", "")

config = load_config("pronto-api")
init_engine(config)

with get_session() as session:
    if target_email:
        email_hash = hash_identifier(target_email)
        emp = session.query(Employee).filter(Employee.email_hash == email_hash).first()
        if not emp:
            print(f"ERROR: Empleado con email '{target_email}' no encontrado.")
            sys.exit(1)
        emp.set_password(password)
        session.add(emp)
        print(f"  -> Password reseteado para {emp.name}")
    else:
        employees = session.query(Employee).all()
        for emp in employees:
            emp.set_password(password)
            session.add(emp)
            print(f"  -> Password reseteado para {emp.name}")

    # Create system user if not exists
    system_user = session.query(Employee).filter(Employee.role == "system").first()
    if not system_user:
        print("Creando usuario system...")
        sys_id = str(uuid4())
        sys_email = "system@pronto.com"
        sys_name = "System Admin"
        email_encrypted = encrypt_string(sys_email)
        name_encrypted = encrypt_string(sys_name)
        email_hash = hash_identifier(sys_email)
        auth_hash = hash_credentials(sys_email, password)

        sql = text("""
            INSERT INTO pronto_employees (
                id, employee_code, first_name, last_name,
                email_encrypted, name_encrypted, email_hash, auth_hash,
                role, is_active, created_at, updated_at, status
            ) VALUES (
                :id, :code, :fname, :lname,
                :email_enc, :name_enc, :email_hash, :auth_hash,
                'system', true, now(), now(), 'active'
            )
        """)
        session.execute(sql, {
            "id": sys_id, "code": "SUS-001",
            "fname": "System", "lname": "Admin",
            "email_enc": email_encrypted, "name_enc": name_encrypted,
            "email_hash": email_hash, "auth_hash": auth_hash,
        })
        print("  -> Creado system@pronto.com")

    session.commit()
    print("Hecho.")
PYEOF

# ── Execute inside container ─────────────────────────────────────
echo "======================================================"
echo "  PRONTO — Reset Passwords (PRONTO_ENV=$PRONTO_ENV)"
echo "======================================================"

docker compose -f "$REPO_ROOT/docker-compose.yml" exec -T \
  -e "_PRONTO_RESET_PW=$PASSWORD" \
  -e "_PRONTO_TARGET_EMAIL=$TARGET_EMAIL" \
  api python3 -c "$PY_SCRIPT"
