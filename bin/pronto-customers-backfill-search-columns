#!/usr/bin/env python3
"""
Backfill search columns for existing customers.
Usage:
    --dry-run   (default) - show what would be updated
    --apply     - actually update the database
"""
import os
import sys

from sqlalchemy import create_engine
from sqlalchemy.orm import Session

from pronto_shared.models import Customer
from pronto_shared.normalize import normalize_email, normalize_name, normalize_phone_e164


BATCH_SIZE = 500

DATABASE_URL = os.getenv("DATABASE_URL", "postgresql://pronto:pronto123@localhost:5432/pronto")


def backfill(engine):
    """Backfill search columns using decrypted properties."""
    with Session(engine) as db:
        total = db.query(Customer).count()
        print(f"Total customers: {total}")
        
        customers = db.query(Customer).order_by(Customer.id).all()
        updated = 0
        
        for i in range(0, len(customers), BATCH_SIZE):
            batch = customers[i:i + BATCH_SIZE]
            
            for c in batch:
                needs_commit = False
                
                # Use decrypted properties directly
                normalized_name = normalize_name(c.name)
                if c.name_search != normalized_name:
                    c.name_search = normalized_name
                    needs_commit = True
                
                normalized_email = normalize_email(c.email)
                if c.email_normalized != normalized_email:
                    c.email_normalized = normalized_email
                    needs_commit = True
                
                normalized_phone = normalize_phone_e164(c.phone)
                if c.phone_e164 != normalized_phone:
                    c.phone_e164 = normalized_phone
                    needs_commit = True
                
                if needs_commit:
                    updated += 1
            
            db.commit()
            print(f"Batch {i // BATCH_SIZE + 1}: {updated}/{total} updated")
        
        print(f"Done. Total updated: {updated}")


if __name__ == "__main__":
    engine = create_engine(DATABASE_URL)
    
    if "--apply" in sys.argv:
        backfill(engine)
    else:
        print("[DRY RUN] Would update customer search columns.")
        with Session(engine) as db:
            total = db.query(Customer).count()
            missing = db.query(Customer).filter(
                Customer.name_search.is_(None) |
                Customer.email_normalized.is_(None) |
                Customer.phone_e164.is_(None)
            ).count()
            print(f"Customers: {total}")
            print(f"Missing search columns: {missing}")
