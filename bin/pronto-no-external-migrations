#!/usr/bin/env bash
set -euo pipefail

CANON="pronto-scripts/init/sql/migrations"

bad=0
while IFS= read -r d; do
  d="${d#./}"
  # Ignore common build artifacts/caches that may exist locally.
  case "$d" in
    */build/*|*/dist/*|*/.ruff_cache/*|*/__pycache__/*|*/venv/*|*/.venv/*|*/node_modules/*)
      continue
      ;;
  esac
  [[ "$d" == "$CANON" ]] && continue
  echo "BAD migrations dir: $d" >&2
  bad=$((bad+1))
done < <(find . -type d -name migrations -print | sort)

if (( bad > 0 )); then
  echo "pronto-no-external-migrations: FAIL (bad=$bad)" >&2
  exit 1
fi

echo "OK: no external migrations/"
