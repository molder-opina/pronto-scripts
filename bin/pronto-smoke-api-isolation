#!/usr/bin/env bash
#
# Smoke Test Script for PRONTO API Isolation
#
# Usage:
#   ./pronto-scripts/bin/pronto-smoke-api-isolation
#
# This script tests the API isolation mode by verifying:
# 1. pronto-api is running and responding
# 2. Key endpoints are accessible
# 3. pronto-employees UI is accessible
# 4. Templates use window.API_BASE correctly
#

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Default values
API_HOST="${API_HOST:-localhost:6082}"
UI_HOST="${UI_HOST:-localhost:6080}"

# Counters
PASSED=0
FAILED=0

# Helper functions
pass() {
    echo -e "${GREEN}✓ PASS${NC}: $1"
    ((PASSED++))
}

fail() {
    echo -e "${RED}✗ FAIL${NC}: $1"
    ((FAILED++))
}

warn() {
    echo -e "${YELLOW}⚠ WARN${NC}: $1"
}

info() {
    echo -e "ℹ INFO${NC}: $1"
}

header() {
    echo ""
    echo "=============================================="
    echo "$1"
    echo "=============================================="
}

# Check if curl is available
if ! command -v curl &> /dev/null; then
    fail "curl is not installed"
    exit 1
fi

header "PRONTO API Isolation Smoke Test"

info "Testing against:"
info "  API:  http://${API_HOST}"
info "  UI:   http://${UI_HOST}"
echo ""

# Test 1: Health check - pronto-api
header "Test 1: pronto-api Health Check"
if curl -sf "http://${API_HOST}/health" > /dev/null 2>&1; then
    pass "pronto-api is running"
    API_HEALTH=$(curl -sf "http://${API_HOST}/health")
    info "API Health Response: $API_HEALTH"
else
    fail "pronto-api is not responding at http://${API_HOST}/health"
fi

# Test 2: Health check - pronto-employees
header "Test 2: pronto-employees Health Check"
if curl -sf "http://${UI_HOST}/health" > /dev/null 2>&1; then
    pass "pronto-employees is running"
    UI_HEALTH=$(curl -sf "http://${UI_HOST}/health")
    info "UI Health Response: $UI_HEALTH"
else
    fail "pronto-employees is not responding at http://${UI_HOST}/health"
fi

# Test 3: Check if /api/stats/public works (no auth required)
header "Test 3: Public Endpoint - /api/stats/public"
if curl -sf "http://${API_HOST}/api/stats/public" > /dev/null 2>&1; then
    pass "/api/stats/public is accessible"
    STATS=$(curl -sf "http://${API_HOST}/api/stats/public")
    info "Stats Response: $STATS"
else
    fail "/api/stats/public is not accessible"
fi

# Test 4: Check if /api/menu works (requires auth, just check endpoint exists)
header "Test 4: Menu Endpoint - /api/menu (should return 401 or valid response)"
HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" "http://${API_HOST}/api/menu")
if [[ "$HTTP_CODE" =~ ^(200|401|403)$ ]]; then
    pass "/api/menu is responding (HTTP $HTTP_CODE)"
else
    fail "/api/menu is not responding correctly (HTTP $HTTP_CODE)"
fi

# Test 5: Check if /api/orders works
header "Test 5: Orders Endpoint - /api/orders (should return 401 or valid response)"
HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" "http://${API_HOST}/api/orders")
if [[ "$HTTP_CODE" =~ ^(200|401|403)$ ]]; then
    pass "/api/orders is responding (HTTP $HTTP_CODE)"
else
    fail "/api/orders is not responding correctly (HTTP $HTTP_CODE)"
fi

# Test 6: Check if /api/sessions/all works
header "Test 6: Sessions Endpoint - /api/sessions/all"
HTTP_CODE=$(curl -sf -o /dev/null -w "%{http_code}" "http://${API_HOST}/api/sessions/all")
if [[ "$HTTP_CODE" =~ ^(200|401|403)$ ]]; then
    pass "/api/sessions/all is responding (HTTP $HTTP_CODE)"
else
    fail "/api/sessions/all is not responding correctly (HTTP $HTTP_CODE)"
fi

# Test 7: Check if UI templates have window.API_BASE
header "Test 7: UI Templates - window.API_BASE"
TEMPLATE_FILE="/Users/molder/projects/github-molder/pronto/pronto-employees/src/pronto_employees/templates/base.html"
if grep -q "window.API_BASE" "$TEMPLATE_FILE" 2>/dev/null; then
    pass "base.html contains window.API_BASE"
else
    fail "base.html does not contain window.API_BASE"
fi

# Test 8: Check if templates use window.API_BASE in fetch calls
header "Test 8: Templates - Use window.API_BASE in fetch"
TEMPLATE_FILES=(
    "/Users/molder/projects/github-molder/pronto/pronto-employees/src/pronto_employees/templates/dashboard.html"
    "/Users/molder/projects/github-molder/pronto/pronto-employees/src/pronto_employees/templates/login_waiter.html"
    "/Users/molder/projects/github-molder/pronto/pronto-employees/src/pronto_employees/templates/login_admin.html"
)

MISSING=0
for file in "${TEMPLATE_FILES[@]}"; do
    if [[ -f "$file" ]]; then
        if grep -q "fetch(\`\${window.API_BASE}" "$file" 2>/dev/null; then
            pass "$(basename "$file") uses window.API_BASE"
        else
            warn "$(basename "$file") may not use window.API_BASE"
            ((MISSING++))
        fi
    fi
done

if [[ $MISSING -eq 0 ]]; then
    pass "All checked templates use window.API_BASE"
else
    fail "$MISSING template(s) may not use window.API_BASE"
fi

# Test 9: Check if employees app.py has api_base_url
header "Test 9: employees/app.py - api_base_url in context processor"
APP_FILE="/Users/molder/projects/github-molder/pronto/pronto-employees/src/pronto_employees/app.py"
if grep -q "api_base_url" "$APP_FILE" 2>/dev/null; then
    pass "app.py contains api_base_url"
else
    fail "app.py does not contain api_base_url"
fi

# Test 10: Check if PRONTO_API_ISOLATION feature flag exists
header "Test 10: Feature Flag - PRONTO_API_ISOLATION"
FEATURE_FLAG_FILE="/Users/molder/projects/github-molder/pronto/pronto-api/src/api_app/feature_flags.py"
if [[ -f "$FEATURE_FLAG_FILE" ]]; then
    if grep -q "PRONTO_API_ISOLATION" "$FEATURE_FLAG_FILE" 2>/dev/null; then
        pass "Feature flag PRONTO_API_ISOLATION is defined"
    else
        fail "Feature flag PRONTO_API_ISOLATION is not defined in feature_flags.py"
    fi
else
    warn "feature_flags.py does not exist"
fi

# Test 11: Check if employees has NO API blueprints registered
header "Test 11: employees/app.py - No /api/* blueprints registered"
if grep -q 'register_blueprint.*url_prefix="/api"' "$APP_FILE" 2>/dev/null; then
    fail "app.py still registers /api/* blueprints"
else
    pass "app.py does not register /api/* blueprints"
fi

# Summary
header "Test Summary"
echo ""
echo -e "Passed: ${GREEN}${PASSED}${NC}"
echo -e "Failed: ${RED}${FAILED}${NC}"
echo ""

if [[ $FAILED -eq 0 ]]; then
    echo -e "${GREEN}All tests passed!${NC}"
    exit 0
else
    echo -e "${YELLOW}Some tests failed. Please review the output above.${NC}"
    exit 1
fi
