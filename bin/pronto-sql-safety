#!/usr/bin/env bash
set -euo pipefail

command -v rg >/dev/null || { echo "pronto-sql-safety: requiere rg" >&2; exit 1; }

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [[ -d "/opt/pronto/pronto-scripts/init/sql" ]]; then
    ROOT="/opt/pronto/pronto-scripts/init/sql"
elif [[ -d "$SCRIPT_DIR/../init/sql" ]]; then
    ROOT="$SCRIPT_DIR/../init/sql"
else
    ROOT="pronto-scripts/init/sql"
fi
[[ -d "$ROOT" ]] || { echo "pronto-sql-safety: missing $ROOT" >&2; exit 1; }

# Global deny in init/sql/**
DENY='(?i)\b(DROP\s+TABLE|DROP\s+SCHEMA|DROP\s+DATABASE|TRUNCATE|--clean|DO\s+\$\$|VACUUM\b|ANALYZE\b|CLUSTER\b)\b'

bad=0
while IFS= read -r hit; do
  echo "$hit" >&2
  bad=$((bad+1))
done < <(rg -n --pcre2 "$DENY" "$ROOT" || true)

# DROP INDEX IF EXISTS allowed ONLY in sql/migrations/
while IFS= read -r hit; do
  file="${hit%%:*}"
  if [[ "$file" != *"/sql/migrations/"* ]]; then
    echo "DROP INDEX IF EXISTS fuera de migrations: $hit" >&2
    bad=$((bad+1))
  fi
done < <(rg -n --pcre2 '(?i)\bDROP\s+INDEX\s+IF\s+EXISTS\b' "$ROOT" || true)

if (( bad > 0 )); then
  echo "pronto-sql-safety: FAIL (bad=$bad)" >&2
  exit 1
fi

echo "OK: sql safety"
