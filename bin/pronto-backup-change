#!/usr/bin/env bash
set -euo pipefail

REPO_ROOT=$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)

REASON=""
AGENT="Codex"
MODULES=""
DB_DUMP=""
DRY_RUN="false"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --reason) REASON="$2"; shift 2;;
    --agent) AGENT="$2"; shift 2;;
    --modules) MODULES="$2"; shift 2;;
    --db-dump) DB_DUMP="$2"; shift 2;;
    --dry-run) DRY_RUN="true"; shift 1;;
    *) echo "Unknown arg: $1"; exit 1;;
  esac
done

CHANGE_ID="CHG-$(date +%Y%m%d-%H%M%S)-$(git -C "$REPO_ROOT" rev-parse --short HEAD 2>/dev/null || echo nogit)"
BKROOT="$REPO_ROOT/pronto-backups/changes/$CHANGE_ID"

if [[ "$DRY_RUN" == "true" ]]; then
  echo "[dry-run] would create $BKROOT"
  exit 0
fi

mkdir -p "$BKROOT"/{meta,patch,files,db,logs}

{
  echo "change_id=$CHANGE_ID"
  echo "ts=$(date -Iseconds)"
  echo "pwd=$REPO_ROOT"
  echo "reason=$REASON"
  echo "agent=$AGENT"
  echo "modules=$MODULES"
  git -C "$REPO_ROOT" rev-parse --abbrev-ref HEAD 2>/dev/null | sed 's/^/branch=/' || true
  git -C "$REPO_ROOT" rev-parse HEAD 2>/dev/null | sed 's/^/commit=/' || true
  git -C "$REPO_ROOT" diff --stat 2>/dev/null | sed 's/^/diffstat=/' || true
} > "$BKROOT/meta/info.env"

git -C "$REPO_ROOT" status --porcelain=v1 > "$BKROOT/meta/git_status.txt" 2>/dev/null || true
git -C "$REPO_ROOT" diff > "$BKROOT/patch/working_tree.diff" 2>/dev/null || true
git -C "$REPO_ROOT" diff --staged > "$BKROOT/patch/staged.diff" 2>/dev/null || true

echo "Backup creado: $BKROOT"
